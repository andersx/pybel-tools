{% extends "bootstrap/base.html" %}

{% import "bootstrap/wtf.html" as wtf %}
{% import "bootstrap/fixes.html" as fixes %}
{% import "bootstrap/utils.html" as util %}

{% block styles %}
    {{ super() }}
    <link href="{{ url_for('static', filename='css/c3.min.css') }}" rel="stylesheet" type="text/css"/>
{% endblock %}

{% block head %}
    {{ super() }}
    {{ fixes.ie8() }}

    <script src="{{ url_for('static', filename='js/d3.3.5.17.min.js') }}" charset="utf-8"></script>
    <script src="{{ url_for('static', filename='js/c3.min.js') }}"></script>
    <script src="//code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://cdn.datatables.net/1.10.13/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.13/js/dataTables.bootstrap.min.js"></script>

{% endblock %}

{% block title %}Summary{% endblock %}

{% block content %}
    {{ util.flashed_messages(dismissible=True) }}
    <div class="container">
        <div class="page-header">
            <h1>Summary of {{ graph.name }}
                <small class="text-muted">{{ graph.version }}</small>
            </h1>
        </div>

        <div class="panel panel-default">
            <div class="panel-heading">
                <h3 class="panel-title">Overview</h3>
            </div>
            <div class="panel-body">
                <dl>
                    {% for key, value in graph.document.items() %}
                        <dt>{{ key }}</dt>
                        <dd>{{ value }}</dd>
                    {% endfor %}
                </dl>
                <a class="btn btn-default" href="{{ url_for('view_explorer', graphid=graph_id) }}"
                   role="button">Explore</a>
                <a class="btn btn-default" href="{{ url_for('get_network', graphid=graph_id, format='bel') }}"
                   role="button"><span class="glyphicon glyphicon-download" aria-hidden="true"></span> BEL Script</a>
                <a class="btn btn-default" href="{{ url_for('get_network', graphid=graph_id, format='json') }}"
                   role="button"><span class="glyphicon glyphicon-download" aria-hidden="true"></span> Nodelink JSON</a>
                <a class="btn btn-default" href="{{ url_for('get_network', graphid=graph_id, format='cx') }}"
                   role="button"><span class="glyphicon glyphicon-download" aria-hidden="true"></span> CX JSON</a>
                <!-- These are still broken...
                <a class="btn btn-default" href="{{ url_for('get_network', graphid=graph_id, format='bytes') }}"
                   role="button"><span class="glyphicon glyphicon-download" aria-hidden="true"></span> Pickle</a>
                <a class="btn btn-default" href="{{ url_for('get_network', graphid=graph_id, format='graphml') }}"
                   role="button"><span class="glyphicon glyphicon-download" aria-hidden="true"></span> GraphML</a>
                <a class="btn btn-default" href="{{ url_for('get_network', graphid=graph_id, format='csv') }}"
                   role="button"><span class="glyphicon glyphicon-download" aria-hidden="true"></span> Excel</a>
                 -->
            </div>
        </div>

        <div class="panel panel-default">
            <div class="panel-heading">
                <h3 class="panel-title">Network Statistics</h3>
            </div>
            <div class="panel-body">
                <dl>
                    {% for key, value in info_list %}
                        <dt>{{ key }}</dt>
                        <dd>{{ value }}</dd>
                    {% endfor %}
                </dl>
            </div>
        </div>

        <div class="panel panel-default">
            <div class="panel-heading">
                <h3 class="panel-title">Statistics</h3>
            </div>
            <div class="panel-body">
                {% if time is not none %}
                    <p>Processing took {{ time }} seconds</p>
                {% endif %}
                <div class="row">
                    <div class="col-md-4">
                        <div id="chart3"></div>
                    </div>
                    <div class="col-md-4">
                        <div id="chart1"></div>
                    </div>
                    <div class="col-md-4">
                        <div id="chart2"></div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-4">
                        <div id="chart4"></div>
                    </div>
                    <div class="col-md-4">
                        <div id="chart5"></div>
                    </div>
                    <div class="col-md-4">
                        <div id="chart6"></div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-4">
                        <div id="chart7"></div>
                    </div>
                    <div class="col-md-4">
                        <div id="chart8"></div>
                    </div>
                    <div class="col-md-4">
                        <div id="chart9"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="panel panel-default panel-table">
            <div class="panel-heading">
                <h3 class="panel-title">All Errors</h3>
            </div>
            <div class="panel-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                        <tr>
                            <th>Line</th>
                            <th>BEL</th>
                            <th>Message</th>
                        </tr>
                        </thead>
                        <tbody id="myTable">
                        {% for number, line, exc, _ in graph.warnings %}
                            <tr>
                                <td>{{ number }}</td>
                                <td><code>{{ line }}</code></td>
                                <td>{{ exc }}</td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="panel-footer">
                <ul class="pagination pagination pagination-sm" style="margin:0;" id="myPager"></ul>
            </div>
        </div>

        <div class="panel panel-default panel-table">
            <div class="panel-heading">
                <h3 class="panel-title">Top Errors</h3>
            </div>
            <div class="panel-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                        <tr>
                            <th>Error</th>
                            <th>Frequency</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for k, v in error_groups %}
                            <tr>
                                <td><code>{{ k }}</code></td>
                                <td>{{ v }}</td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>


        <div class="panel panel-default">
            <div class="panel-heading">
                <h3 class="panel-title">Contradictory Edges</h3>
            </div>
            <div class="panel-body">
                <p>These pairs of nodes have a contradiction in their causal relationships, meaning they have more than
                    one of <code>INCREASES</code>, <code>DECREASES</code>, or <code>CAUSES NO CHANGE</code>. This may be
                    due to different experimental conditions, so these edges need to be carefully considered in
                    analyses.
                </p>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                        <tr>
                            <th>Source</th>
                            <th>Relations</th>
                            <th>Target</th>

                        </tr>
                        </thead>
                        <tbody>
                        {% for source, target, relations in contradictions %}
                            <tr>
                                <td>{{ source }}</td>
                                <td>{{ ', '.join(relations) }}</td>
                                <td>{{ target }}</td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="panel panel-default">
            <div class="panel-heading">
                <h3 class="panel-title">Unstable Pairs</h3>
            </div>
            <div class="panel-body">
                <dl>
                    <dt>Chaotic Pairs</dt>
                    <dd>Nodes that mutually increase each other, such as when both <code>A increases B</code> and <code>B
                        increases A</code>.
                    </dd>
                    <dt>Dampened Pairs</dt>
                    <dd>Nodes that mutually decrease each other, such as when both <code>A decreases B</code> and <code>B
                        decreases A</code>.
                    </dd>
                </dl>
                <p>While neither chaotic nor dampened pairs are biologically invalid, they require additional context to
                    understand their regulation.</p>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                        <tr>
                            <th>Node A</th>
                            <th>Node B</th>
                            <th>Type</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for a, b, label in unstable_pairs %}
                            <tr>
                                <td>{{ a }}</td>
                                <td>{{ b }}</td>
                                <td>{{ label }}</td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="panel panel-default">
            <div class="panel-heading">
                <h3 class="panel-title">Unstable Triplets</h3>
            </div>
            <div class="panel-body">
                <p>Analysis of triple stability comes from a deep graph theoretic background. It identifies triangles
                    within the graph that have logically inconsistent relations</p>
                <dl>
                    <dt>Separately Unstable Triplet</dt>
                    <dd>When both <code>A positiveCorrelation B</code>, <code>B negativeCorrelation C</code>, but <code>C
                        positiveCorrelation A</code>.
                    </dd>
                    <dt>Mutually Unstable Triplets</dt>
                    <dd>When both <code>A negativeCorrelation B</code>, <code>B negativeCorrelation C</code>, and <code>C
                        negativeCorrelation A</code>.
                    </dd>
                    <dt>Jens Unstable Triplet*</dt>
                    <dd>When <code>A increases B</code>, <code>A decreases C</code>, and <code>C positiveCorrelation
                        A</code>.
                    </dd>
                    <dt>Increase Mismatch Triplet*</dt>
                    <dd>When <code>A increases B</code>, <code>A increases C</code>, and <code>C negativeCorrelation
                        A</code>.
                    </dd>
                    <dt>Decrease Mismatch Triplet*</dt>
                    <dd>When <code>A decreases B</code>, <code>A decreases C</code>, and <code>C negativeCorrelation
                        A</code>.
                    </dd>
                    <dt>Chaotic Triplets*</dt>
                    <dd>A triplet of nodes that mutually increase each other, such as when <code>A increases B</code>,
                        <code>B increases C</code>, and <code>C increases A</code>.
                    </dd>
                    <dt>Dampened Triplets*</dt>
                    <dd>A triplet of nodes that mutually decreases each other, such as when <code>A decreases B</code>,
                        <code>B decreases C</code>, and <code>C decreases A</code>.
                    </dd>
                </dl>
                <p>Analysis with astericks have not been implemented and are not yet shown.</p>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                        <tr>
                            <th>Node A</th>
                            <th>Node B</th>
                            <th>Node C</th>
                            <th>Type</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for a, b, c, label in unstable_correlation_triplets %}
                            <tr>
                                <td>{{ a }}</td>
                                <td>{{ b }}</td>
                                <td>{{ c }}</td>
                                <td>{{ label }}</td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    {{ super() }}

    <script>
        $.fn.pageMe = function (opts) {
            var $this = this,
                defaults = {
                    perPage: 7,
                    showPrevNext: false,
                    hidePageNumbers: false
                },
                settings = $.extend(defaults, opts);

            var listElement = $this;
            var perPage = settings.perPage;
            var children = listElement.children();
            var pager = $('.pager');

            if (typeof settings.childSelector != "undefined") {
                children = listElement.find(settings.childSelector);
            }

            if (typeof settings.pagerSelector != "undefined") {
                pager = $(settings.pagerSelector);
            }

            var numItems = children.size();
            var numPages = Math.ceil(numItems / perPage);

            pager.data("curr", 0);

            if (settings.showPrevNext) {
                $('<li><a href="#" class="prev_link">«</a></li>').appendTo(pager);
            }

            var curr = 0;
            while (numPages > curr && (settings.hidePageNumbers === false)) {
                $('<li><a href="#" class="page_link">' + (curr + 1) + '</a></li>').appendTo(pager);
                curr++;
            }

            if (settings.showPrevNext) {
                $('<li><a href="#" class="next_link">»</a></li>').appendTo(pager);
            }

            pager.find('.page_link:first').addClass('active');
            pager.find('.prev_link').hide();
            if (numPages <= 1) {
                pager.find('.next_link').hide();
            }
            pager.children().eq(1).addClass("active");

            children.hide();
            children.slice(0, perPage).show();

            pager.find('li .page_link').click(function () {
                var clickedPage = $(this).html().valueOf() - 1;
                goTo(clickedPage, perPage);
                return false;
            });
            pager.find('li .prev_link').click(function () {
                previous();
                return false;
            });
            pager.find('li .next_link').click(function () {
                next();
                return false;
            });

            function previous() {
                var goToPage = parseInt(pager.data("curr")) - 1;
                goTo(goToPage);
            }

            function next() {
                goToPage = parseInt(pager.data("curr")) + 1;
                goTo(goToPage);
            }

            function goTo(page) {
                var startAt = page * perPage,
                    endOn = startAt + perPage;

                children.css('display', 'none').slice(startAt, endOn).show();

                if (page >= 1) {
                    pager.find('.prev_link').show();
                }
                else {
                    pager.find('.prev_link').hide();
                }

                if (page < (numPages - 1)) {
                    pager.find('.next_link').show();
                }
                else {
                    pager.find('.next_link').hide();
                }

                pager.data("curr", page);
                pager.children().removeClass("active");
                pager.children().eq(page + 1).addClass("active");

            }
        };

        $(document).ready(function () {

            $('#myTable').pageMe({pagerSelector: '#myPager', showPrevNext: true, hidePageNumbers: false, perPage: 20});

        });
    </script>

    <script>
        var chart1 = c3.generate({
            padding: {
                top: 15,
                left: 100
            },
            size: {
                height: 350
            },
            bindto: '#chart1',
            data: {
                x: 'x',
                columns: {{ chart_1_data|safe}},
                type: 'bar'
            },
            title: {
                text: 'Entity Frequency ({{ graph.number_of_nodes() }})'
            },
            axis: {
                rotated: true,
                x: {
                    type: 'category'
                }
            },
            legend: {
                show: false
            }
        });

        var chart2 = c3.generate({
            padding: {
                top: 15,
                left: 100
            },
            size: {
                height: 350
            },
            bindto: '#chart2',
            data: {
                x: 'x',
                columns: {{ chart_2_data|safe}},
                type: 'bar'
            },
            title: {
                text: 'Relationship Frequency ({{ graph.number_of_edges() }})'
            },
            axis: {
                rotated: true,
                x: {
                    type: 'category'
                }
            },
            legend: {
                show: false
            }
        });

        var chart3 = c3.generate({
            padding: {
                top: 15,
                left: 100
            },
            size: {
                height: 350
            },
            bindto: '#chart3',
            data: {
                x: 'x',
                columns: {{ chart_3_data|safe}},
                type: 'bar'
            },
            title: {
                text: 'Error Frequency ({{ graph.warnings.__len__() }})'
            },
            axis: {
                rotated: true,
                x: {
                    type: 'category'
                }
            },
            legend: {
                show: false
            }
        });

        var chart4 = c3.generate({
            padding: {
                top: 15,
                left: 100
            },
            size: {
                height: 350
            },
            bindto: '#chart4',
            data: {
                x: 'x',
                columns: {{ chart_4_data|safe}},
                type: 'bar'
            },
            title: {
                text: 'Node Transformations'
            },
            axis: {
                rotated: true,
                x: {
                    type: 'category'
                }
            },
            legend: {
                show: false
            }
        });

        var chart5 = c3.generate({
            padding: {
                top: 15,
                left: 100
            },
            size: {
                height: 350
            },
            bindto: '#chart5',
            data: {
                x: 'x',
                columns: {{ chart_5_data|safe}},
                type: 'bar'
            },
            title: {
                text: 'Node Modifications'
            },
            axis: {
                rotated: true,
                x: {
                    type: 'category'
                }
            },
            legend: {
                show: false
            }
        });

        var chart6 = c3.generate({
            padding: {
                top: 15,
                left: 100
            },
            size: {
                height: 350
            },
            bindto: '#chart6',
            data: {
                x: 'x',
                columns: {{ chart_6_data|safe}},
                type: 'bar'
            },
            title: {
                text: 'Namespaces'
            },
            axis: {
                rotated: true,
                x: {
                    type: 'category'
                }
            },
            legend: {
                show: false
            }
        });

        var chart7 = c3.generate({
            padding: {
                top: 15,
                left: 100
            },
            size: {
                height: 350
            },
            bindto: '#chart7',
            data: {
                x: 'x',
                columns: {{ chart_7_data|safe}},
                type: 'bar'
            },
            title: {
                text: 'Top Nodes by Degree'
            },
            axis: {
                rotated: true,
                x: {
                    type: 'category'
                }
            },
            legend: {
                show: false
            }
        });

        var chart8 = c3.generate({
            padding: {
                top: 15,
                left: 100
            },
            size: {
                height: 350
            },
            bindto: '#chart8',
            data: {
                x: 'x',
                columns: {{ chart_8_data|safe}},
                type: 'bar'
            },
            title: {
                text: 'Top Nodes by Centrality'
            },
            axis: {
                rotated: true,
                x: {
                    type: 'category'
                }
            },
            legend: {
                show: false
            }
        });

        var chart9 = c3.generate({
            padding: {
                top: 15,
                left: 100
            },
            size: {
                height: 350
            },
            bindto: '#chart9',
            data: {
                x: 'x',
                columns: {{ chart_9_data|safe}},
                type: 'bar'
            },
            title: {
                text: 'Diseases'
            },
            axis: {
                rotated: true,
                x: {
                    type: 'category'
                }
            },
            legend: {
                show: false
            }
        });


    </script>
{% endblock %}
